<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <title>Chart</title>
</head>
<body>
    <div class="container-lg">
        <div class="row">
            <div class="col">
                <select name="table" id="table" class="form-select form-select-sm">
                    <option value="">-- Select --</option>       
                </select>
            </div>
                <br>
            <div class="col">
                <select name="column" id="column" class="form-select form-select-sm">
                    <option value="">-- Select --</option>
                </select>
            </div>
            
            <div class="col-1">
                <button name="generate" id="generate" class="btn btn-info btn-sm text-wrap">
                    Create</button>
            </div>

            <div class="col-2 form-check" id="sortable" data-toggle="popover" data-bs-trigger="focus" title="Alert" data-bs-content="Sorting the data may result into a increase in time taken to generate the chart">
                <input class="form-check-input" type="checkbox" value="" id="sort_data" />
                <label class="form-check-label" for="sort_data" id="sort_data_text">Sort data</label>
            </div>
            
        </div>
        <div class="container">
            <div class="row">
                <div class="col-sm-8">
                    <canvas id="myChart" width="2" height="2"></canvas>
             </div>
            </div>
        </div>

    </div>

<script>
    $(document).focusin(function() {
  $('#sortable').popover();
})

    //populates the select fields.
    $.ajax({
    method: "GET",
    url: "http://127.0.0.1:5000/db_info/",
    dataType:"json",
    success: function(json_data){
        var option = '';
        for(const [key,value] of Object.entries(json_data)){ 
        console.log(`  ${key}: ${value}`)

        console.log(json_data[key].length)
        option += '<option value="'+ `  ${key} `+ '">' + `  ${key} ` + '</option>';
        }
        $('#table').append(option);
        $('#table').change(function(){  
            var ooption = '';         
            var selectedOption = String($(this).children("option:selected").val())
            //THIS IS ABSOLUTELY NEEDED FOR THIS TO WORK, WHEN YOU GET THE TEXT IT WILL HAVE WHITESPACES!!!!!
            var res = selectedOption.replace(/\s+/g, "");
            console.log(res);
            console.log(json_data[res])
            for(var i=0;i<json_data[res].length;i++){
            ooption += '<option value="'+ `  ${json_data[res][parseInt(i)]} `+ '">' + `  ${json_data[res][parseInt(i)]} ` + '</option>';
             }
        $('#column')
        .empty()        
        .append(ooption);

        })


    }})
    $('#generate').click(function(e){
        var selectedTable = String($('#table').children("option:selected").val())
        var selectedColumn = String($('#column').children("option:selected").val())
        var selectedTable = selectedTable.replace(/\s+/g, "");
        var selectedColumn = selectedColumn.replace(/\s+/g, "");
        e.preventDefault();
        $.ajax({
            method: "GET",
            url: "http://127.0.0.1:5000/get_data/",
            dataType:"json",
            data: jQuery.param({ table: selectedTable, column : selectedColumn}),
            success: function (json_data) {
                console.log(json_data)

        let myArray = json_data.reduce(function(accumulator, currentValue) {
        return accumulator[currentValue] ? ++accumulator[currentValue] : accumulator[currentValue] = 1, accumulator},{});

        
        const chart_exists = Chart.getChart("myChart");
        function generate_chart(data){
            const cdata = {
                datasets: [{
                        label: 'Total',
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
            };
            
            const config =  {
                type: 'bar',
                data: cdata,
                options: {
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            }
            const myChart = new Chart(
                document.getElementById('myChart'),
                config
            );
            return myChart
        }
            console.log($('#sort_data').is(':checked')); 
          if (chart_exists !== undefined){
             console.log(myArray)
             myChart.destroy()
         }
         chart_data = myArray
         if ($('#sort_data').is(':checked')){
            //this is used to sort the array. got this code from Jason J. Nathan: on https://stackoverflow.com/questions/1069666/sorting-object-property-by-values
            let sorted = Object
            .entries(myArray)
            .sort((a, b) => b[1] - a[1])
            .reduce((_sortedObj, [k,v]) => ({
            ..._sortedObj, 
            [k]: v
            }), {})
         chart_data = sorted
         }
         myChart = generate_chart(chart_data)


    },
    error: function(error_data){
        console.log("error")
        console.log(error_data)
    }
            

        })
    })
    
</script>    
</body>
</html>